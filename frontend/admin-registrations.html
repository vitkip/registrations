<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô - Certificate Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Enhanced Pagination Styles */
        .pagination-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 2.5rem;
            height: 2.5rem;
            padding: 0.5rem;
            margin: 0 0.125rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-decoration: none;
        }

        .pagination-btn:hover:not(.disabled) {
            background-color: #f9fafb;
            border-color: #3b82f6;
            color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-color: #3b82f6;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
            color: #9ca3af;
        }

        .pagination-btn.disabled:hover {
            transform: none;
            box-shadow: none;
            background-color: #f3f4f6;
            border-color: #d1d5db;
            color: #9ca3af;
        }

        /* Loading state for table */
        .table-loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Page size selector enhanced styles */
        #page-size-selector {
            font-size: 0.875rem;
            border-radius: 0.5rem;
        }

        #page-size-selector:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        /* Responsive pagination */
        @media (max-width: 640px) {
            .pagination-btn {
                min-width: 2.25rem;
                height: 2.25rem;
                font-size: 0.75rem;
                margin: 0 0.0625rem;
            }
            
            .pagination-btn span {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center">
                <a href="admin-dashboard.html" class="navbar-brand flex items-center">
                    <span class="text-2xl mr-2">üìã</span>
                    ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô
                </a>
            </div>
            <div class="navbar-nav flex items-center">
                <a href="admin-dashboard.html" class="nav-link">‚Üê Dashboard</a>
                <span id="user-info" class="mr-4 text-white/90"></span>
                <button onclick="logout()" class="nav-link">‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Alerts Container -->
        <div id="alerts-container" class="mb-6"></div>

        <!-- Filters -->
        <div class="card mb-6">
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="form-group">
                        <label class="form-label lao-text">‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</label>
                        <input type="text" id="search-input" class="form-input" placeholder="‡∫ä‡∫∑‡ªà, ‡∫≠‡∫µ‡ªÄ‡∫°‡∫•, ‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ô‡∫±‡∫Å‡∫™‡∫∂‡∫Å‡∫™‡∫≤">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label lao-text">‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞</label>
                        <select id="status-filter" class="form-input">
                            <option value="">‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</option>
                            <option value="pending">‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î</option>
                            <option value="approved">‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß</option>
                            <option value="rejected">‡∫õ‡∫∞‡∫ï‡∫¥‡ªÄ‡∫™‡∫î</option>
                            <option value="certificate_issued">‡∫≠‡∫≠‡∫Å‡ªÉ‡∫ö‡∫¢‡∫±‡ªâ‡∫á‡∫¢‡∫∑‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label lao-text">‡ªÄ‡∫ñ‡∫¥‡∫á‡∫ß‡∫±‡∫ô‡∫ó‡∫µ</label>
                        <input type="date" id="date-to" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label lao-text">‡∫à‡∫≤‡∫Å‡∫ß‡∫±‡∫ô‡∫ó‡∫µ</label>
                        <input type="date" id="date-from" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button onclick="applyFilters()" class="btn-primary w-full">üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registrations Table -->
        <div class="card">
            <div class="card-header">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold lao-text">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô</h2>
                    <div class="flex gap-2">
                        <button onclick="showExportModal()" class="btn-secondary">üìä ‡∫™‡∫ª‡ªà‡∫á‡∫≠‡∫≠‡∫Å</button>
                        <button onclick="refreshData()" class="btn-primary">üîÑ ‡ªÇ‡∫´‡∫•‡∫î‡ªÉ‡ªù‡ªà</button>
                    </div>
                </div>
                
                <!-- Page Size Selector -->
                <div class="flex items-center gap-4 text-sm text-gray-600">
                    <div class="flex items-center gap-2">
                        <label class="font-medium">‡∫™‡∫∞‡ªÅ‡∫î‡∫á:</label>
                        <select id="page-size-selector" onchange="changePageSize()" class="px-3 py-1 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 bg-white">
                            <option value="10" selected>10 ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</option>
                            <option value="25">25 ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</option>
                            <option value="50">50 ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</option>
                            <option value="100">100 ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</option>
                        </select>
                        <span>‡∫ï‡ªç‡ªà‡ªú‡ªâ‡∫≤</span>
                    </div>
                    
                    <div id="total-records-info" class="text-gray-500">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ô‡∫±‡∫Å‡∫™‡∫∂‡∫Å‡∫™‡∫≤</th>
                                <th>‡∫ä‡∫∑‡ªà - ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô</th>
                                <th>‡∫≠‡∫µ‡ªÄ‡∫°‡∫•</th>
                                <th>‡∫™‡∫≤‡∫Ç‡∫≤‡∫ß‡∫¥‡∫ä‡∫≤</th>
                                <th>‡∫õ‡∫µ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î</th>
                                <th>‡∫Ñ‡ªà‡∫≤‡∫ó‡∫≥‡∫ô‡∫Ω‡∫°</th>
                                <th>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞</th>
                                <th>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô</th>
                                <th>‡∫Å‡∫≤‡∫ô‡∫î‡∫≥‡ªÄ‡∫ô‡∫µ‡∫ô‡∫á‡∫≤‡∫ô</th>
                            </tr>
                        </thead>
                        <tbody id="registrations-table">
                            <tr>
                                <td colspan="9" class="text-center py-8 text-gray-500">
                                    <span class="spinner mr-2"></span>‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="pagination-container" class="mt-6"></div>
            </div>
        </div>
    </div>

    <!-- Registration Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                            <span class="text-2xl">üë§</span>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold lao-text">‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô</h3>
                            <p class="text-blue-100 text-sm" id="modal-student-code">Student Registration Details</p>
                        </div>
                    </div>
                    <button onclick="hideDetailModal()" class="text-white hover:text-gray-200 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="overflow-y-auto" style="max-height: calc(95vh - 160px);">
                <div class="p-8">
                    <div id="detail-content" class="space-y-8">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                    
                    <!-- Status Update Section -->
                    <div id="status-update-section" class="mt-8 pt-6 border-t border-gray-200">
                        <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-2xl p-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-8 h-8 bg-blue-500 text-white rounded-lg flex items-center justify-center">
                                    <span class="text-sm">‚öôÔ∏è</span>
                                </div>
                                <h4 class="text-xl font-bold text-blue-800 lao-text">‡∫õ‡∫±‡∫ö‡∫õ‡∫∏‡∫á‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞</h4>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡ªÉ‡ªù‡ªà</label>
                                    <select id="new-status" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                                        <option value="pending">üïê ‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î</option>
                                        <option value="approved">‚úÖ ‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î</option>
                                        <option value="rejected">‚ùå ‡∫õ‡∫∞‡∫ï‡∫¥‡ªÄ‡∫™‡∫î</option>
                                        <option value="certificate_issued">üéì ‡∫≠‡∫≠‡∫Å‡ªÉ‡∫ö‡∫¢‡∫±‡ªâ‡∫á‡∫¢‡∫∑‡∫ô</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="updateRegistrationStatus()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold px-6 py-3 rounded-xl shadow-lg hover:shadow-blue-500/25 transform hover:scale-105 transition-all duration-300">
                                        <span class="flex items-center justify-center gap-2">
                                            <span>üíæ</span> ‡∫õ‡∫±‡∫ö‡∫õ‡∫∏‡∫á
                                        </span>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î (‡∫™‡∫∞‡ªÄ‡∫û‡∫≤‡∫∞)</label>
                                <textarea id="status-notes" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all resize-none" placeholder="‡ªÉ‡∫™‡ªà‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÄ‡∫ï‡∫µ‡∫°..." rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 lao-text">‡∫™‡∫ª‡ªà‡∫á‡∫≠‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</h3>
            
            <form id="export-form">
                <div class="form-group">
                    <label class="form-label lao-text">‡∫Æ‡∫π‡∫ö‡ªÅ‡∫ö‡∫ö</label>
                    <select name="format" class="form-input">
                        <option value="excel">Excel (.xls)</option>
                        <option value="csv">CSV (.csv)</option>
                    </select>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="btn-primary flex-1">üìä ‡∫™‡∫ª‡ªà‡∫á‡∫≠‡∫≠‡∫Å</button>
                    <button type="button" onclick="hideExportModal()" class="btn-secondary">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script>
        let currentPage = 1;
        let currentPageSize = 10;
        let currentRegistration = null;
        let userInfo = null;

        // Check authentication
        async function checkAuth() {
            if (!api.token) {
                window.location.href = 'admin-login.html';
                return;
            }

            try {
                const result = await api.verifyToken();
                if (!result.success) {
                    throw new Error('Token verification failed');
                }
                
                userInfo = result.user;
                document.getElementById('user-info').textContent = `${userInfo.full_name} (${userInfo.role})`;
                
            } catch (error) {
                console.error('Auth check failed:', error);
                api.removeToken();
                window.location.href = 'admin-login.html';
            }
        }

        // Load registrations
        async function loadRegistrations(page = 1, pageSize = null) {
            currentPage = page;
            if (pageSize) {
                currentPageSize = pageSize;
            }
            
            try {
                const filters = getFilters();
                const result = await api.getRegistrations(page, currentPageSize, filters);
                
                if (result.success) {
                    displayRegistrations(result.registrations);
                    displayPagination(result.pagination);
                    
                    // Update page size selector
                    const selector = document.getElementById('page-size-selector');
                    if (selector && selector.value != currentPageSize) {
                        selector.value = currentPageSize;
                    }
                } else {
                    UIUtils.showAlert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', 'error');
                }
            } catch (error) {
                console.error('Failed to load registrations:', error);
                UIUtils.showAlert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', 'error');
            } finally {
                // Always remove loading state
                showTableLoading(false);
            }
        }

        function getFilters() {
            return {
                search: document.getElementById('search-input').value,
                status: document.getElementById('status-filter').value,
                date_from: document.getElementById('date-from').value,
                date_to: document.getElementById('date-to').value
            };
        }

        function displayRegistrations(registrations) {
            const tbody = document.getElementById('registrations-table');
            
            if (!registrations || registrations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô</td></tr>';
                return;
            }

            // Debug registrations data
            console.log('Registrations loaded:', registrations.length);
            registrations.forEach((reg, index) => {
                console.log(`Registration ${index + 1}:`, {
                    id: reg.id,
                    student_code: reg.student_code,
                    name: reg.first_name + ' ' + reg.last_name,
                    profile_image: reg.profile_image,
                    payment_proof: reg.payment_proof
                });
            });

            tbody.innerHTML = registrations.map(reg => `
                <tr class="hover:bg-gray-50">
                    <td class="font-mono">${reg.student_code}</td>
                    <td>${reg.first_name} ${reg.last_name}</td>
                    <td>${reg.email}</td>
                    <td>${reg.major || '-'}</td>
                    <td>${reg.graduation_year || '-'}</td>
                    <td>${Number(reg.payment_amount).toLocaleString()} LAK</td>
                    <td>${UIUtils.getStatusBadge(reg.status)}</td>
                    <td>${UIUtils.formatDateLao(reg.registration_date)}</td>
                    <td>
                        <div class="flex gap-2">
                            <button onclick="showRegistrationDetail(${reg.id})" class="text-blue-600 hover:text-blue-800 text-sm">
                                üëÅÔ∏è ‡ªÄ‡∫ö‡∫¥‡ªà‡∫á
                            </button>
                            ${userInfo.role === 'admin' ? 
                                `<button onclick="deleteRegistration(${reg.id})" class="text-red-600 hover:text-red-800 text-sm">
                                    üóëÔ∏è ‡∫•‡∫∂‡∫ö
                                </button>` : ''
                            }
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function displayPagination(pagination) {
            const container = document.getElementById('pagination-container');
            
            // Update total records info in header
            const totalInfoElement = document.getElementById('total-records-info');
            const startRecord = ((pagination.current_page - 1) * pagination.per_page) + 1;
            const endRecord = Math.min(pagination.current_page * pagination.per_page, pagination.total_records);
            
            totalInfoElement.innerHTML = `
                <span class="flex items-center gap-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${pagination.total_records} ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î
                    </span>
                    <span class="text-gray-400">|</span>
                    <span>‡∫™‡∫∞‡ªÅ‡∫î‡∫á ${startRecord}-${endRecord}</span>
                </span>
            `;
            
            if (pagination.total_pages <= 1) {
                container.innerHTML = `
                    <div class="flex justify-center items-center py-4">
                        <span class="text-gray-500 text-sm">‡ªú‡ªâ‡∫≤‡∫î‡∫Ω‡∫ß (${pagination.total_records} ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô)</span>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 px-6 py-4">
                        <!-- Left: Page Info -->
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span class="hidden sm:inline">‡ªú‡ªâ‡∫≤</span>
                            <span class="font-semibold text-blue-600">${pagination.current_page}</span>
                            <span class="hidden sm:inline">‡∫à‡∫≤‡∫Å</span>
                            <span class="font-semibold">${pagination.total_pages}</span>
                        </div>
                        
                        <!-- Center: Navigation Controls -->
                        <div class="flex items-center gap-1">
            `;
            
            // First page button
            if (pagination.current_page > 1) {
                html += `
                    <button onclick="loadRegistrations(1)" class="pagination-btn ${pagination.current_page === 1 ? 'disabled' : ''}" title="‡ªú‡ªâ‡∫≤‡ªÅ‡∫•‡∫Å">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7M20 19l-7-7 7-7"/>
                        </svg>
                    </button>
                `;
            }
            
            // Previous button
            html += `
                <button onclick="loadRegistrations(${pagination.current_page - 1})" 
                        class="pagination-btn ${pagination.current_page <= 1 ? 'disabled' : ''}" 
                        ${pagination.current_page <= 1 ? 'disabled' : ''} title="‡ªú‡ªâ‡∫≤‡∫Å‡ªà‡∫≠‡∫ô‡ªú‡ªâ‡∫≤">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
            `;

            // Page numbers with smart truncation
            const maxVisiblePages = 5;
            let startPage = Math.max(1, pagination.current_page - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(pagination.total_pages, startPage + maxVisiblePages - 1);
            
            // Adjust start if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Show first page if not in range
            if (startPage > 1) {
                html += `<button onclick="loadRegistrations(1)" class="pagination-btn">1</button>`;
                if (startPage > 2) {
                    html += `<span class="px-2 text-gray-400">...</span>`;
                }
            }
            
            // Page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === pagination.current_page;
                html += `
                    <button onclick="loadRegistrations(${i})" 
                            class="pagination-btn ${isActive ? 'active' : ''}" 
                            ${isActive ? 'aria-current="page"' : ''}>
                        ${i}
                    </button>
                `;
            }
            
            // Show last page if not in range
            if (endPage < pagination.total_pages) {
                if (endPage < pagination.total_pages - 1) {
                    html += `<span class="px-2 text-gray-400">...</span>`;
                }
                html += `<button onclick="loadRegistrations(${pagination.total_pages})" class="pagination-btn">${pagination.total_pages}</button>`;
            }

            // Next button
            html += `
                <button onclick="loadRegistrations(${pagination.current_page + 1})" 
                        class="pagination-btn ${pagination.current_page >= pagination.total_pages ? 'disabled' : ''}" 
                        ${pagination.current_page >= pagination.total_pages ? 'disabled' : ''} title="‡ªú‡ªâ‡∫≤‡∫ï‡ªç‡ªà‡ªÑ‡∫õ">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            `;
            
            // Last page button
            if (pagination.current_page < pagination.total_pages) {
                html += `
                    <button onclick="loadRegistrations(${pagination.total_pages})" class="pagination-btn ${pagination.current_page === pagination.total_pages ? 'disabled' : ''}" title="‡ªú‡ªâ‡∫≤‡∫™‡∫∏‡∫î‡∫ó‡ªâ‡∫≤‡∫ç">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M4 5l7 7-7 7"/>
                        </svg>
                    </button>
                `;
            }
            
            html += `
                        </div>
                        
                        <!-- Right: Quick Jump -->
                        <div class="flex items-center gap-2 text-sm">
                            <label class="text-gray-600 hidden sm:inline">‡ªÑ‡∫õ‡ªú‡ªâ‡∫≤:</label>
                            <input type="number" 
                                   id="jump-to-page" 
                                   min="1" 
                                   max="${pagination.total_pages}" 
                                   value="${pagination.current_page}"
                                   class="w-16 px-2 py-1 text-center border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-200"
                                   onkeypress="if(event.key==='Enter') jumpToPage()">
                            <button onclick="jumpToPage()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded transition-colors">
                                ‡ªÑ‡∫õ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Show registration detail
        async function showRegistrationDetail(id) {
            console.log('=== showRegistrationDetail called with ID:', id);
            console.log('API URL will be:', `${window.location.origin}/backend/admin/registrations.php?page=1&limit=1&id=${id}`);
            try {
                const result = await api.getRegistrations(1, 1, { id });
                console.log('API response:', result);
                console.log('Number of registrations returned:', result.registrations?.length || 0);
                
                if (result.success && result.registrations.length > 0) {
                    currentRegistration = result.registrations[0];
                    console.log('Setting currentRegistration to:', {
                        id: currentRegistration.id,
                        student_code: currentRegistration.student_code,
                        name: currentRegistration.first_name + ' ' + currentRegistration.last_name,
                        status: currentRegistration.status
                    });
                    displayRegistrationDetail(currentRegistration);
                    document.getElementById('detail-modal').classList.remove('hidden');
                } else {
                    console.error('No registration found for ID:', id);
                    UIUtils.showAlert('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô', 'error');
                }
            } catch (error) {
                console.error('Failed to load registration detail:', error);
                UIUtils.showAlert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡ªÇ‡∫´‡∫•‡∫î‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î', 'error');
            }
        }

        function displayRegistrationDetail(reg) {
            console.log('=== displayRegistrationDetail called ===');
            console.log('Registration Detail:', {
                id: reg.id,
                student_code: reg.student_code,
                name: reg.first_name + ' ' + reg.last_name,
                profile_image: reg.profile_image,
                payment_proof: reg.payment_proof
            });
            
            // Update modal header with student code
            console.log('Updating modal header with student code:', reg.student_code);
            document.getElementById('modal-student-code').textContent = `‡∫•‡∫∞‡∫´‡∫±‡∫î: ${reg.student_code}`;
            
            console.log('About to generate HTML for ID:', reg.id);
            
            // Clear previous content first to avoid ID conflicts
            document.getElementById('detail-content').innerHTML = '';
            
            // Generate fresh content with unique IDs
            document.getElementById('detail-content').innerHTML = `
                <!-- Personal Information Card -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border-l-4 border-blue-500">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-500 text-white rounded-xl flex items-center justify-center shadow-lg">
                            <span class="text-lg">üë§</span>
                        </div>
                        <div>
                            <h4 class="text-xl font-bold text-blue-800 lao-text">‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡ªà‡∫ß‡∫ô‡∫ï‡∫ª‡∫ß</h4>
                            <p class="text-sm text-blue-600">Personal Information</p>
                        </div>
                    </div>
                    
                    <!-- Student Code & Status (Highlighted Section) -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6 border border-blue-100">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1">
                                <div class="text-center p-4 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg">
                                    <div class="flex items-center justify-center mb-2">
                                        <span class="text-2xl">üÜî</span>
                                    </div>
                                    <label class="text-xs uppercase tracking-wide opacity-90 block mb-1">‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ô‡∫±‡∫Å‡∫™‡∫∂‡∫Å‡∫™‡∫≤</label>
                                    <div class="flex items-center justify-center gap-2">
                                        <p class="font-mono font-bold text-xl">${reg.student_code}</p>
                                        <button onclick="copyToClipboard('${reg.student_code}')" class="text-white hover:text-blue-200 p-1 rounded transition-colors" title="Copy Student Code">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="md:col-span-1">
                                <div class="text-center p-4 bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-200 rounded-xl">
                                    <div class="flex items-center justify-center mb-2">
                                        <span class="text-2xl">üìä</span>
                                    </div>
                                    <label class="text-xs uppercase tracking-wide text-gray-500 block mb-2">‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞</label>
                                    <div class="flex justify-center">${UIUtils.getStatusBadge(reg.status)}</div>
                                </div>
                            </div>
                            
                            <div class="md:col-span-1">
                                <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-xl">
                                    <div class="flex items-center justify-center mb-2">
                                        <span class="text-2xl">üìÖ</span>
                                    </div>
                                    <label class="text-xs uppercase tracking-wide text-green-600 block mb-1">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô</label>
                                    <p class="font-bold text-green-700 text-sm">${UIUtils.formatDateLao(reg.registration_date)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Personal Details Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Name -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">üë§</span>
                                <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">‡∫ä‡∫∑‡ªà - ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô</label>
                            </div>
                            <p class="font-bold text-lg text-gray-800">${reg.first_name} ${reg.last_name}</p>
                            <p class="text-xs text-gray-500 mt-1">Full Name</p>
                        </div>
                        
                        <!-- Gender -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">${reg.gender === 'Male' ? 'üë®' : 'üë©'}</span>
                                <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">‡ªÄ‡∫û‡∫î</label>
                            </div>
                            <p class="font-bold text-lg ${reg.gender === 'Male' ? 'text-blue-600' : 'text-pink-600'}">${reg.gender === 'Male' ? '‡∫û‡∫£‡∫∞ (Male)' : '‡∫™.‡∫ô (Female)'}</p>
                            <p class="text-xs text-gray-500 mt-1">Gender</p>
                        </div>
                        
                        <!-- Date of Birth -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">üéÇ</span>
                                <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">‡∫ß‡∫±‡∫ô‡ªÄ‡∫Å‡∫µ‡∫î</label>
                            </div>
                            <p class="font-bold text-lg text-gray-800">${reg.date_of_birth}</p>
                            <p class="text-xs text-gray-500 mt-1">Date of Birth</p>
                        </div>
                        
                        <!-- Phone -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">üì±</span>
                                <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <p class="font-bold text-lg text-gray-800">${reg.phone}</p>
                                <a href="tel:${reg.phone}" class="text-green-600 hover:text-green-700 p-1 rounded-full hover:bg-green-50 transition-all" title="Call ${reg.phone}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                </a>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Phone Number</p>
                        </div>
                        
                        <!-- Email -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow lg:col-span-2">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">üìß</span>
                                <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">‡∫≠‡∫µ‡ªÄ‡∫°‡∫•</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <p class="font-bold text-lg text-gray-800 break-all">${reg.email}</p>
                                <a href="mailto:${reg.email}" class="text-blue-600 hover:text-blue-700 p-1 rounded-full hover:bg-blue-50 transition-all flex-shrink-0" title="Send Email to ${reg.email}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 3.26a2 2 0 001.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                </a>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Email Address</p>
                        </div>
                        
                        <!-- Major -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow lg:col-span-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">üéì</span>
                                <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">‡∫™‡∫≤‡∫Ç‡∫≤‡∫ß‡∫¥‡∫ä‡∫≤</label>
                            </div>
                            <p class="font-bold text-xl text-purple-600">${reg.major || '-'}</p>
                            <p class="text-xs text-gray-500 mt-1">Major / Field of Study</p>
                        </div>
                    </div>
                </div>
                
                <!-- Academic & Payment Information Card -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 border-l-4 border-green-500">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-green-500 text-white rounded-lg flex items-center justify-center">
                            <span class="text-sm">üéì</span>
                        </div>
                        <h4 class="text-xl font-bold text-green-800 lao-text">‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡∫∂‡∫Å‡∫™‡∫≤ ‡ªÅ‡∫•‡∫∞ ‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <label class="text-sm font-medium text-gray-500 block mb-1">‡∫õ‡∫µ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫™‡∫∂‡∫Å‡∫™‡∫≤</label>
                            <p class="font-bold text-lg text-green-600">üéì ${reg.graduation_year || '-'}</p>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <label class="text-sm font-medium text-gray-500 block mb-1">‡∫Ñ‡ªà‡∫≤‡∫ó‡∫≥‡∫ô‡∫Ω‡∫°</label>
                            <p class="font-bold text-lg text-green-600">üí∞ ${Number(reg.payment_amount).toLocaleString()} LAK</p>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <label class="text-sm font-medium text-gray-500 block mb-1">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫™‡ªâ‡∫≤‡∫á</label>
                            <p class="font-medium text-gray-700">${UIUtils.formatDateLao(reg.created_at)}</p>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <label class="text-sm font-medium text-gray-500 block mb-1">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫≠‡∫±‡∫ö‡ªÄ‡∫î‡∫î</label>
                            <p class="font-medium text-gray-700">${UIUtils.formatDateLao(reg.updated_at)}</p>
                        </div>
                        
                        ${reg.notes ? `
                        <div class="md:col-span-2 bg-white rounded-xl p-4 shadow-sm">
                            <label class="text-sm font-medium text-gray-500 block mb-1">‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î</label>
                            <p class="bg-yellow-50 p-3 rounded-lg border-l-4 border-yellow-400 text-gray-700">${reg.notes}</p>
                        </div>` : ''}
                    </div>
                </div>
                
                <!-- Files & Documents Card -->
                <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-2xl p-6 border-l-4 border-orange-500">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-orange-500 text-white rounded-lg flex items-center justify-center">
                            <span class="text-sm">üìé</span>
                        </div>
                        <h4 class="text-xl font-bold text-orange-800 lao-text">‡ªÄ‡∫≠‡∫Å‡∫∞‡∫™‡∫≤‡∫ô ‡ªÅ‡∫•‡∫∞ ‡ªÑ‡∫ü‡∫•‡ªå</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Profile Image Section -->
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="text-lg">üì∑</span>
                                <h5 class="font-semibold text-gray-800">‡∫Æ‡∫π‡∫ö‡ªÇ‡∫õ‡∫£‡ªÑ‡∫ü‡∫•‡ªå</h5>
                            </div>
                            
                            <div class="relative group">
                                ${reg.profile_image ? 
                                    `<div class="relative" id="profile-container-${reg.id}">
                                        <!-- Debug Info -->
                                        <div class="absolute top-0 left-0 bg-blue-600 text-white text-xs px-2 py-1 rounded-br-lg z-10">
                                            ID: ${reg.id} | ${reg.profile_image}
                                        </div>
                                        <img id="profile-img-${reg.id}" 
                                             src="${window.location.origin}/${reg.profile_image}" 
                                             alt="Profile Image - ${reg.first_name} ${reg.last_name}" 
                                             class="w-full h-64 object-cover rounded-xl border-2 border-gray-200 cursor-pointer hover:border-blue-500 transition-all duration-300 shadow-md hover:shadow-lg"
                                             onclick="openImageModal('${window.location.origin}/${reg.profile_image}', 'Profile Image - ${reg.first_name} ${reg.last_name}')"
                                             onerror="handleImageError('profile-img-${reg.id}', 'profile-container-${reg.id}', '${reg.profile_image}', 'Profile')"
                                             onload="console.log('Profile image loaded successfully for ID ${reg.id}:', '${reg.profile_image}')"
                                        
                                        <!-- Overlay with actions -->
                                        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all duration-300 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100">
                                            <div class="flex gap-2">
                                                <button onclick="openImageModal('${window.location.origin}/${reg.profile_image}', 'Profile Image - ${reg.first_name} ${reg.last_name}')" 
                                                        class="bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-700 p-3 rounded-full shadow-lg transition-all">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                    </svg>
                                                </button>
                                                <a href="${window.location.origin}/${reg.profile_image}" download="${reg.first_name}_${reg.last_name}_profile.jpg"
                                                   class="bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-700 p-3 rounded-full shadow-lg transition-all">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                    </svg>
                                                </a>
                                            </div>
                                        </div>
                                        
                                        <!-- File info badge -->
                                        <div class="absolute top-3 right-3 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-medium shadow-lg">
                                            ‚úÖ ‡∫°‡∫µ‡ªÑ‡∫ü‡∫•‡ªå
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 text-center">
                                        <p class="text-xs text-gray-500">‡∫Å‡∫ª‡∫î‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫Ç‡∫∞‡ªú‡∫≤‡∫î‡ªÄ‡∫ï‡∫±‡∫°</p>
                                        <p class="text-xs text-gray-400 mt-1 font-mono">${reg.profile_image}</p>
                                    </div>` :
                                    `<div class="w-full h-64 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center">
                                        <div class="text-center text-gray-400">
                                            <span class="text-5xl block mb-3">üì∑</span>
                                            <p class="text-sm font-medium">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Æ‡∫π‡∫ö‡ªÇ‡∫õ‡∫£‡ªÑ‡∫ü‡∫•‡ªå</p>
                                            <p class="text-xs mt-1">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫•‡∫î‡∫Æ‡∫π‡∫ö‡ªÇ‡∫õ‡∫£‡ªÑ‡∫ü‡∫•‡ªå</p>
                                        </div>
                                    </div>`
                                }
                            </div>
                        </div>
                        
                        <!-- Payment Proof Section -->
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="text-lg">üí∞</span>
                                <h5 class="font-semibold text-gray-800">‡∫´‡∫º‡∫±‡∫Å‡∫ñ‡∫≤‡∫ô‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞</h5>
                            </div>
                            
                            <div class="relative group">
                                ${reg.payment_proof ? 
                                    (reg.payment_proof.toLowerCase().includes('.pdf') ? 
                                        `<div class="w-full h-64 bg-red-50 border-2 border-red-200 rounded-xl flex items-center justify-center relative group cursor-pointer hover:border-red-400 transition-all"
                                             onclick="window.open('${window.location.origin}/${reg.payment_proof}', '_blank')">
                                            <!-- Debug Info -->
                                            <div class="absolute top-0 left-0 bg-red-600 text-white text-xs px-2 py-1 rounded-br-lg z-10">
                                                ID: ${reg.id} | ${reg.payment_proof}
                                            </div>
                                            <div class="text-center">
                                                <span class="text-6xl block mb-3 text-red-500">üìÑ</span>
                                                <p class="text-sm font-semibold text-red-700">PDF ‡ªÄ‡∫≠‡∫Å‡∫∞‡∫™‡∫≤‡∫ô</p>
                                                <p class="text-xs text-red-500 mt-1">‡∫Å‡∫ª‡∫î‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫õ‡∫µ‡∫î PDF</p>
                                            </div>
                                            
                                            <!-- PDF Actions -->
                                            <div class="absolute inset-0 bg-red-500 bg-opacity-0 hover:bg-opacity-10 transition-all duration-300 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100">
                                                <div class="flex gap-2">
                                                    <button onclick="event.stopPropagation(); window.open('${window.location.origin}/${reg.payment_proof}', '_blank')" 
                                                            class="bg-white bg-opacity-90 hover:bg-opacity-100 text-red-600 p-3 rounded-full shadow-lg transition-all">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                        </svg>
                                                    </button>
                                                    <a href="${window.location.origin}/${reg.payment_proof}" download="${reg.first_name}_${reg.last_name}_payment.pdf"
                                                       class="bg-white bg-opacity-90 hover:bg-opacity-100 text-red-600 p-3 rounded-full shadow-lg transition-all"
                                                       onclick="event.stopPropagation()">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                        </svg>
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <div class="absolute top-3 right-3 bg-red-500 text-white px-3 py-1 rounded-full text-xs font-medium shadow-lg">
                                                üìÑ PDF
                                            </div>
                                        </div>` :
                                        `<div class="relative" id="payment-container-${reg.id}">
                                            <!-- Debug Info -->
                                            <div class="absolute top-0 left-0 bg-green-600 text-white text-xs px-2 py-1 rounded-br-lg z-10">
                                                ID: ${reg.id} | ${reg.payment_proof}
                                            </div>
                                            <img id="payment-img-${reg.id}"
                                                 src="${window.location.origin}/${reg.payment_proof}" 
                                                 alt="Payment Proof - ${reg.first_name} ${reg.last_name}" 
                                                 class="w-full h-64 object-cover rounded-xl border-2 border-gray-200 cursor-pointer hover:border-green-500 transition-all duration-300 shadow-md hover:shadow-lg"
                                                 onclick="openImageModal('${window.location.origin}/${reg.payment_proof}', 'Payment Proof - ${reg.first_name} ${reg.last_name}')"
                                                 onerror="handleImageError('payment-img-${reg.id}', 'payment-container-${reg.id}', '${reg.payment_proof}', 'Payment Proof')"
                                                 onload="console.log('Payment image loaded successfully for ID ${reg.id}:', '${reg.payment_proof}')"
                                            
                                            <!-- Overlay with actions -->
                                            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all duration-300 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100">
                                                <div class="flex gap-2">
                                                    <button onclick="openImageModal('${window.location.origin}/${reg.payment_proof}', 'Payment Proof - ${reg.first_name} ${reg.last_name}')" 
                                                            class="bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-700 p-3 rounded-full shadow-lg transition-all">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                        </svg>
                                                    </button>
                                                    <a href="${window.location.origin}/${reg.payment_proof}" download="${reg.first_name}_${reg.last_name}_payment.jpg"
                                                       class="bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-700 p-3 rounded-full shadow-lg transition-all">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                        </svg>
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <div class="absolute top-3 right-3 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-medium shadow-lg">
                                                ‚úÖ ‡∫°‡∫µ‡ªÑ‡∫ü‡∫•‡ªå
                                            </div>
                                        </div>`
                                    ) + `
                                    <div class="mt-3 text-center">
                                        <p class="text-xs text-gray-500">‡∫Å‡∫ª‡∫î‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫Ç‡∫∞‡ªú‡∫≤‡∫î‡ªÄ‡∫ï‡∫±‡∫°</p>
                                        <p class="text-xs text-gray-400 mt-1 font-mono">${reg.payment_proof}</p>
                                    </div>` :
                                    `<div class="w-full h-64 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center">
                                        <div class="text-center text-gray-400">
                                            <span class="text-5xl block mb-3">üí∞</span>
                                            <p class="text-sm font-medium">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫´‡∫º‡∫±‡∫Å‡∫ñ‡∫≤‡∫ô‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞</p>
                                            <p class="text-xs mt-1">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫•‡∫î‡∫´‡∫º‡∫±‡∫Å‡∫ñ‡∫≤‡∫ô‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞‡ªÄ‡∫á‡∫¥‡∫ô</p>
                                        </div>
                                    </div>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Set current status in dropdown
            document.getElementById('new-status').value = reg.status;
            document.getElementById('status-notes').value = reg.notes || '';
            
            // Debug image loading after a short delay
            setTimeout(() => {
                console.log('=== Checking for duplicate IDs ===');
                const profileImages = document.querySelectorAll('[id*="profile-img-"]');
                const paymentImages = document.querySelectorAll('[id*="payment-img-"]');
                console.log('Profile images found:', profileImages.length);
                console.log('Payment images found:', paymentImages.length);
                
                profileImages.forEach(img => console.log('Profile image ID:', img.id, 'src:', img.src));
                paymentImages.forEach(img => console.log('Payment image ID:', img.id, 'src:', img.src));
                
                debugImageLoading();
            }, 500);
        }

        // Update registration status
        async function updateRegistrationStatus() {
            if (!currentRegistration) return;
            
            const newStatus = document.getElementById('new-status').value;
            const notes = document.getElementById('status-notes').value;
            
            const statusText = {
                'pending': 'üïê ‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î',
                'approved': '‚úÖ ‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î',
                'rejected': '‚ùå ‡∫õ‡∫∞‡∫ï‡∫¥‡ªÄ‡∫™‡∫î',
                'certificate_issued': 'üéì ‡∫≠‡∫≠‡∫Å‡ªÉ‡∫ö‡∫¢‡∫±‡ªâ‡∫á‡∫¢‡∫∑‡∫ô'
            };
            
            const result = await Swal.fire({
                title: '‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫õ‡∫±‡∫ö‡∫õ‡∫∏‡∫á‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞',
                html: `
                    <div class="text-left">
                        <p class="mb-2"><strong>‡∫ô‡∫±‡∫Å‡∫™‡∫∂‡∫Å‡∫™‡∫≤:</strong> ${currentRegistration.first_name} ${currentRegistration.last_name}</p>
                        <p class="mb-2"><strong>‡∫•‡∫∞‡∫´‡∫±‡∫î:</strong> ${currentRegistration.student_code}</p>
                        <p class="mb-2"><strong>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡ªÉ‡ªù‡ªà:</strong> ${statusText[newStatus]}</p>
                        ${notes ? `<p class="mb-2"><strong>‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î:</strong> ${notes}</p>` : ''}
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô',
                cancelButtonText: '‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å',
                customClass: {
                    popup: 'rounded-xl shadow-xl'
                }
            });
            
            if (!result.isConfirmed) return;

            try {
                const updateResult = await api.updateRegistration(currentRegistration.id, newStatus, notes);
                
                if (updateResult.success) {
                    await Swal.fire({
                        title: '‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!',
                        text: '‡∫õ‡∫±‡∫ö‡∫õ‡∫∏‡∫á‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß',
                        icon: 'success',
                        confirmButtonColor: '#10b981',
                        customClass: {
                            popup: 'rounded-xl shadow-xl'
                        }
                    });
                    hideDetailModal();
                    loadRegistrations(currentPage);
                } else {
                    Swal.fire({
                        title: '‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î!',
                        text: updateResult.message || '‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î',
                        icon: 'error',
                        confirmButtonColor: '#ef4444',
                        customClass: {
                            popup: 'rounded-xl shadow-xl'
                        }
                    });
                }
            } catch (error) {
                console.error('Status update failed:', error);
                Swal.fire({
                    title: '‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î!',
                    text: '‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫õ‡∫±‡∫ö‡∫õ‡∫∏‡∫á‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞',
                    icon: 'error',
                    confirmButtonColor: '#ef4444',
                    customClass: {
                        popup: 'rounded-xl shadow-xl'
                    }
                });
            }
        }

        // Delete registration
        async function deleteRegistration(id) {
            if (userInfo.role !== 'admin') {
                UIUtils.showAlert('‡∫ó‡ªà‡∫≤‡∫ô‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫™‡∫¥‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', 'error');
                return;
            }
            
            if (!confirm('‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡ªà‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫ô‡∫µ‡ªâ? ‡∫Å‡∫≤‡∫ô‡∫Å‡∫∞‡∫ó‡∫≥‡∫ô‡∫µ‡ªâ‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡ªÑ‡∫î‡ªâ!')) {
                return;
            }

            try {
                const result = await api.deleteRegistration(id);
                
                if (result.success) {
                    UIUtils.showAlert('‡∫•‡∫∂‡∫ö‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
                    loadRegistrations(currentPage);
                } else {
                    UIUtils.showAlert(result.message || '‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î', 'error');
                }
            } catch (error) {
                console.error('Delete failed:', error);
                UIUtils.showAlert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', 'error');
            }
        }

        // Modal functions
        function hideDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            currentRegistration = null;
        }

        function showExportModal() {
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function hideExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        // Pagination utility functions
        function changePageSize() {
            const selector = document.getElementById('page-size-selector');
            const newPageSize = parseInt(selector.value);
            currentPageSize = newPageSize;
            
            // Show loading state
            showTableLoading(true);
            
            // Reset to first page when changing page size
            loadRegistrations(1, newPageSize);
        }

        function jumpToPage() {
            const input = document.getElementById('jump-to-page');
            const targetPage = parseInt(input.value);
            
            // Validate page number
            if (isNaN(targetPage) || targetPage < 1) {
                input.value = currentPage;
                UIUtils.showAlert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫•‡∫Å‡ªú‡ªâ‡∫≤‡∫ó‡∫µ‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á', 'warning');
                return;
            }
            
            // Get max pages from the pagination info (we'll need to track this)
            const maxPages = parseInt(document.querySelector('#jump-to-page').getAttribute('max'));
            if (targetPage > maxPages) {
                input.value = currentPage;
                UIUtils.showAlert(`‡ªú‡ªâ‡∫≤‡∫™‡∫π‡∫á‡∫™‡∫∏‡∫î‡ªÅ‡∫°‡ªà‡∫ô ${maxPages}`, 'warning');
                return;
            }
            
            // Show loading state
            showTableLoading(true);
            
            loadRegistrations(targetPage);
        }

        function showTableLoading(show = true) {
            const table = document.querySelector('.table-container table');
            if (show) {
                table.classList.add('table-loading');
            } else {
                table.classList.remove('table-loading');
            }
        }

        // Filter and utility functions
        function applyFilters() {
            showTableLoading(true);
            loadRegistrations(1);
        }

        function refreshData() {
            showTableLoading(true);
            loadRegistrations(currentPage);
        }

        // Export form submission
        document.getElementById('export-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const filters = {
                format: formData.get('format'),
                ...getFilters()
            };
            
            api.exportRegistrations(filters.format || 'excel', filters);
            hideExportModal();
            UIUtils.showAlert('‡∫Å‡∫≤‡∫ô‡∫™‡∫ª‡ªà‡∫á‡∫≠‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß', 'info');
        });

        // Logout function
        async function logout() {
            if (confirm('‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡ªà‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö?')) {
                try {
                    await api.logout();
                } catch (error) {
                    console.error('Logout error:', error);
                }
                
                api.removeToken();
                window.location.href = 'admin-login.html';
            }
        }

        // Image Modal for full-screen viewing
        function openImageModal(src, title) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="relative max-w-full max-h-full">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="absolute -top-12 right-0 text-white hover:text-gray-300 text-2xl bg-black bg-opacity-50 rounded-full p-2 z-10">
                        √ó
                    </button>
                    <img src="${src}" alt="${title}" 
                         class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl">
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white p-4 rounded-b-lg">
                        <p class="text-center font-medium">${title}</p>
                        <div class="flex justify-center mt-2 gap-2">
                            <a href="${src}" download class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm transition-colors">
                                üì• ‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫•‡∫î
                            </a>
                            <button onclick="window.open('${src}', '_blank')" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm transition-colors">
                                üîó ‡ªÄ‡∫õ‡∫µ‡∫î‡ªÉ‡∫ô Tab ‡ªÉ‡ªù‡ªà
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Close on click outside image
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Close on Escape key
            const handleKeyDown = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
            
            document.body.appendChild(modal);
        }

        // Copy to clipboard function
        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show success toast
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full';
                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>‚úÖ</span>
                        <span>‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß: ${text}</span>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-x-full');
                }, 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }).catch(() => {
                alert('‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡ªÑ‡∫î‡ªâ');
            });
        };

        // Close modals when clicking outside
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target.id === 'detail-modal') {
                hideDetailModal();
            }
        });

        document.getElementById('export-modal').addEventListener('click', (e) => {
            if (e.target.id === 'export-modal') {
                hideExportModal();
            }
        });

        // Search on Enter key
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Skip if typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            // ESC to close modals
            if (e.key === 'Escape') {
                hideDetailModal();
                hideExportModal();
            }
            
            // Ctrl/Cmd + R to refresh
            if ((e.ctrlKey || e.metaKey) && e.key === 'r' && !e.shiftKey) {
                e.preventDefault();
                refreshData();
            }
            
            // Ctrl/Cmd + E to export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                showExportModal();
            }
            
            // Ctrl/Cmd + F to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('search-input').focus();
            }
            
            // Arrow keys for pagination navigation
            if (e.key === 'ArrowLeft' && e.ctrlKey) {
                e.preventDefault();
                if (currentPage > 1) {
                    showTableLoading(true);
                    loadRegistrations(currentPage - 1);
                }
            }
            
            if (e.key === 'ArrowRight' && e.ctrlKey) {
                e.preventDefault();
                const jumpInput = document.getElementById('jump-to-page');
                const maxPages = parseInt(jumpInput.getAttribute('max'));
                if (currentPage < maxPages) {
                    showTableLoading(true);
                    loadRegistrations(currentPage + 1);
                }
            }
        });

        // Auto-refresh data every 30 seconds
        let autoRefreshInterval;
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                // Don't auto-refresh if modal is open or user is typing
                if (!document.getElementById('detail-modal').classList.contains('hidden')) {
                    return;
                }
                
                // Don't auto-refresh if user is actively interacting
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) {
                    return;
                }
                
                // Refresh silently without loading indicator
                loadRegistrations(currentPage, currentPageSize);
            }, 30000); // 30 seconds
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // Page visibility handling
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadRegistrations();
            startAutoRefresh();
            
            // Show keyboard shortcuts hint
            setTimeout(() => {
                const hint = document.createElement('div');
                hint.className = 'fixed bottom-4 left-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-40';
                hint.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>üí°</span>
                        <span>‡∫Ñ‡∫≥‡ªÅ‡∫ô‡∫∞‡∫ô‡∫≥: ‡∫Å‡∫ª‡∫î Ctrl+F ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤, Ctrl+R ‡ªÇ‡∫´‡∫•‡∫î‡ªÉ‡ªù‡ªà, Ctrl+E ‡∫™‡∫ª‡ªà‡∫á‡∫≠‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">√ó</button>
                    </div>
                `;
                document.body.appendChild(hint);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (hint.parentElement) {
                        hint.remove();
                    }
                }, 5000);
            }, 2000);
        });

        // Safe image error handler to prevent cross-contamination
        function handleImageError(imageId, containerId, imagePath, imageType) {
            console.log('Image Error:', { imageId, containerId, imagePath, imageType });
            
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('Container not found:', containerId);
                return;
            }
            
            const errorMessage = imageType === 'Profile' ? '‡∫Æ‡∫π‡∫ö‡ªÇ‡∫õ‡∫£‡ªÑ‡∫ü‡∫•‡ªå' : '‡∫´‡∫º‡∫±‡∫Å‡∫ñ‡∫≤‡∫ô‡∫Å‡∫≤‡∫ô‡∫ä‡∫≥‡∫•‡∫∞';
            
            container.innerHTML = `
                <div class="w-full h-64 bg-red-50 border-2 border-red-200 rounded-xl flex items-center justify-center">
                    <div class="text-center text-red-500">
                        <span class="text-4xl block mb-2">‚ö†Ô∏è</span>
                        <p class="text-sm font-medium">‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÇ‡∫´‡∫º‡∫î${errorMessage}‡ªÑ‡∫î‡ªâ</p>
                        <p class="text-xs text-red-400 mt-1 font-mono break-all px-4">${imagePath}</p>
                        <p class="text-xs text-gray-500 mt-1">Container: ${containerId} | Image: ${imageId}</p>
                        <div class="mt-3">
                            <button onclick="location.reload()" 
                                    class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg transition-colors">
                                üîÑ ‡ªÇ‡∫´‡∫•‡∫î‡ªÉ‡ªù‡ªà
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Debug function to check image loading
        function debugImageLoading() {
            const images = document.querySelectorAll('img[id*="profile-img-"], img[id*="payment-img-"]');
            console.log('Found images:', images.length);
            images.forEach(img => {
                console.log(`Image ${img.id}: src="${img.src}" alt="${img.alt}"`);
            });
        }
    </script>
</body>
</html>